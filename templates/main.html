<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>Vote chess</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/fomantic-ui/2.9.0/semantic.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/fomantic-ui/2.9.0/semantic.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Saira:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>
<script>
    function refresh_talk () {
        $.get("/api/message",function(data){
            $("#talk").empty();
            for (let i in data) {
                $("#talk").append(`
                    <div class="ui segment">
                        <div class="comment" data-id="${data[i].id}">
                            <div class="content">
                                <a class="author">${data[i].username}</a>
                                <div class="metadata">
                                    <span class="date">${moment.utc(data[i].time).fromNow()}</span>
                                </div>
                                <div class="text">
                                    ${data[i].content}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }
        });
    }
    function loadmore_talk (){
        let lastid=$("#talk").children().last().children().first().attr("data-id");
        $.get("/api/message",data= {lastid:lastid}, function (data){
            for (let i in data) {
                $("#talk").append(`
                    <div class="ui segment">
                        <div class="comment" data-id="${data[i].id}">
                            <div class="content">
                                <a class="author">${data[i].username}</a>
                                <div class="metadata">
                                    <span class="date">${moment.utc(data[i].time).fromNow()}</span>
                                </div>
                                <div class="text">
                                    ${data[i].content}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }
        })
    }
    $(document).ready(function () {
        $(".toast").toast({
            displayTime: 3000,
            showProgress: 'bottom',
            position: 'top right'
        });
      {% if current_user.is_authenticated and not current_user.allowed %}
      $.modal({
        title: 'Your account is not allowed to vote.',
        closeIcon: true,
        content: 'Your account may still be under review or banned by the administrator. Please contact the administrator for more information.',
        actions: [{
          text: 'Alright, got it',
          class: 'green'
        }]
      }).modal('show');
      {% endif %}
        $.get("./api/board", function (data) {
            let config = {
                pieceTheme: "../static/chessboard/img/chesspieces/wikipedia/{piece}.png",
                position: data.FEN
            };
            var board = Chessboard('board', config);
            if (data.turn === "BLACK"){
              board.flip();
            }
            $("#info").text(`${data.turn} to move. Make your choice`);
        })
        $("#vote").click(function () {
            let move = $("#move").val();
            $.get("./api/legal", data = { move: move }, function (data) {
                if (data == "-1") {
                    $("#moveinput").attr("class", "ui action input error");
                    setTimeout(function () {
                        $("#moveinput").attr("class", "ui action input");
                        $("#move").val("")
                    }, 500)
                }
                else {

                        // console.log(move);
                        $.post("/api/vote", data = { move: move }, function (data) {
                            if (data.status == "success") {
                                swal("成功", `您投了 ${move}`, "success");
                            }
                            else {
                                swal("错误", data.message, "error");
                            }
                        });

                }
            });
        });
        $("#joinwhite").click(function () {
                $.post("/api/apply", data = { color: 1 }, function (data) {
                    if (data.status == "success") {
                        swal("成功", `报名了 White`, "success");
                    }
                    else {
                        swal("错误", data.message, "error");
                    }
                });
        });
        $("#joinblack").click(function () {
                $.post("/api/apply", data = { color: 0 }, function (data) {
                    if (data.status == "success") {
                        swal("成功", `报名了 Black`, "success");
                    }
                    else {
                        swal("错误", data.message, "error");
                    }
                });
        });
        $.get("/api/current",function(data){
            console.log(data)
            for (let u in data) {
                $("#movetable").children("tbody").append(`<tr><td>${u}</td><td>${data[u]?data[u]:"Not voted"}</td></tr>`);
            }
        });
        $('.tabular.menu .item').tab();
        $("#talk_submit").click(function (){
            let content = $("#talk_input").val();
            $.post("/api/send",data={content:content},function(data){
                if (data.status == "success") {
                  $.toast({
                    message: 'Message sent',
                    class: 'success'
                  });
                  $("#talk_input").val("");
                  refresh_talk();
                }
                else {
                  $.toast({
                    message: 'Message failed to send',
                    class: 'error'
                  });
                }
            });
        });
        $("#talk_refresh").click(function (){
            refresh_talk();
        });
        {% if not current_user.allowed or show_apply %}
            $(".dimmer").dimmer("show");
        {% endif %}
        refresh_talk();
        $("#talk").parent().scroll(function (){
          {#console.log($(this).scrollTop() + $(this).innerHeight() , $("#talk")[0].scrollHeight);#}
            if ($(this).scrollTop() + $(this).innerHeight() >= $("#talk")[0].scrollHeight){
                loadmore_talk();
            }
        })
    });
</script>

<body>

    <div class="ui borderless top menu">
        <div class="ui container">
            <a class="item" href="/">
                <p style="font-family: 'Saira', sans-serif;">Vote chess</p>
            </a>
            <a class="item" href="/"><i class="home icon"></i>Home</a>
            <div class="right menu">
                {% if not current_user.is_authenticated %}
                    <a class="item" href="/account/login"><i class="sign in alternate icon"></i>Login</a>
                    <a class="item" href="/account/apply">Register</a>
                {% else %}
                    <div class="ui item simple dropdown">
                    <i class="user icon"></i>
                        {{ current_user.username }}
                        <i class="dropdown icon"></i>
                        <div class="menu">
                            <a class="item" href="/account/logout"><i class="sign out alternate icon"></i>Logout</a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="ui container">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
        {% for cat,mes in messages %}
            <div class="ui {{ cat }} toast"> <div class="content">{{ mes }}</div></div>
        {% endfor %} {% endif %} {% endwith %}
        <div class="ui two column grid">
            <div class="two column row">
                <div class="six wide column">
                    <div id="board" style="width: 400px"></div>
                </div>
                <div class="ten wide column">
                    <div class="ui two column grid" style="margin-top: 5px; ">
                        <div class="eight wide column">
                            <p id="info" style="font-weight: bold; margin-bottom: 1em;"></p>
                            {% if current_user.allowed %}
                            <div class="ui action input" id="moveinput">
                                <input type="text" id="move">
                                <button class="ui button" id="vote">Vote!</button>
                            </div>
                            {% endif %}
                            <table class="ui single line table" id="movetable">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Move</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                </tbody>
                            </table>
                        </div>
                        <div class="eight wide column">
                            <div class="ui tabular menu" style="margin-bottom: unset;">
                                <div class="item" data-tab="talk">Talk</div>
                                <div class="item" data-tab="Setting">Setting</div>
                            </div>
                            <div class="ui tab" data-tab="talk">
                                <div class="ui raised segment">
                                    <div class="ui basic segment" style="height: 300px;overflow: auto;">
                                        <div class="ui comments" id="talk">
                                        </div>
                                    </div>
                                    {% if current_user.is_authenticated %}
                                        <div class="ui fluid action input">
                                            <button class="ui icon button" id="talk_refresh"><i class="sync icon"></i></button>
                                            <input type="text" id="talk_input">
                                                <button class="ui primary button" id="talk_submit">Send</button>
                                        </div>
                                    {% endif %}
                                    <div class="ui inverted dimmer">
                                        <div class="content">
                                          <h2 class="ui icon header">
                                            <i class="lock icon"></i>
                                                Only the users who have joined the game can talk.
                                          </h2>
                                        </div>
                                      </div>
                                </div>
                            </div>
                            {% if show_apply %}
                            <div class="ui horizontal segments" id="joinform">
                                <div class="ui segment">
                                    <button class="fluid ui basic button" id="joinwhite">Join White</button>
                                </div>
                                <div class="ui segment">
                                    <button class="fluid ui black button" id="joinblack">Join Black</button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>